@page "/drone-sim"
@using PursuitSim_v2.Blazor.Services
@using PursuitSim_v2.Core.Common
@using System.Collections.Concurrent
@inject PursuitSim_v2.Blazor.Services.SimulationService SimService
@inject IJSRuntime JS
@inject SimulationService SimService

<h3>Drone Simulation</h3>

<button @onclick="RunSimulation" disabled="@SimService.IsRunning">
    @(SimService.IsRunning ? "Running..." : "Run simulation")
</button>

<hr />

<div @ref="logContainer"
     style="height:300px;
            overflow:auto;
            background:#0e0e0e;
            color:#d0d0d0;
            padding:8px;
            font-family:Consolas, monospace;
            font-size:13px;
            border:1px solid #333;">

    @foreach (var log in LogSnapshot)
    {
        <div>
            <span style="color:#888">[@log.Time:HH:mm:ss]</span>
            <span style="color:#6cf">[@log.Level]</span>
            <span> @log.Message</span>
        </div>
    }

</div>

<hr />

<h4>Map</h4>

<svg width="600" height="600"
     style="border:1px solid #444; background:#fafafa">

    @if (Current != null)
    {
        @foreach (var r in Current.Runners)
        {
            <circle cx="@MapX(r.X)"
                    cy="@MapY(r.Y)"
                    r="4"
                    fill="@(r.KO ? "gray" : "blue")" />
        }

        <circle cx="@MapX(Current.Drone.X)"
                cy="@MapY(Current.Drone.Y)"
                r="6"
                fill="red" />
    }

</svg>

@code {

    private SimulationSnapshot? Current;
    private readonly ConcurrentQueue<LogEntry> _logQueue = new();
    private record LogEntry(DateTime Time, string Level, string Message);
    private ElementReference logContainer;
    private readonly object _logLock = new();
    private IReadOnlyList<LogEntry> LogSnapshot =>
    _logQueue.ToArray();

    protected override void OnInitialized()
    {
        SimService.OnLog += OnLogReceived;
        SimService.OnTick += OnTickReceived;
    }


    private async Task RunSimulation()
    {
        _logQueue.Clear();

        var scenario = PursuitSim_v2.Core.DroneSim.Scenarios.PlainWithHedges();
        await SimService.RunDroneSimAsync(scenario);
    }

    private void OnLogReceived(string msg)
    {
        _logQueue.Enqueue(new LogEntry(DateTime.Now, "INFO", msg));

        while (_logQueue.Count > 500)
            _logQueue.TryDequeue(out _);

        InvokeAsync(StateHasChanged);
    }



    private void OnTickReceived(SimulationSnapshot snap)
    {
        Current = snap;
        InvokeAsync(StateHasChanged);
    }


    const double WorldSize = 1000.0;
    const double ViewSize = 600.0;

    double MapX(double x) => x / WorldSize * ViewSize;
    double MapY(double y) => ViewSize - (y / WorldSize * ViewSize);


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await JS.InvokeVoidAsync("scrollToBottom", logContainer);
    }
}
